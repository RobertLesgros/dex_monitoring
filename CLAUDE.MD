# Projet DEX Monitoring - Alternative Nexthink

## Vue d'ensemble
Syst√®me de monitoring de l'exp√©rience utilisateur digital (DEX) bas√© sur PowerShell c√¥t√© client avec remont√©e JSON vers une stack ELK (Elasticsearch, Logstash, Kibana).

## Objectifs du projet
- Collecter des m√©triques d'exp√©rience utilisateur depuis les endpoints Windows
- Centraliser les donn√©es dans Elasticsearch via Logstash
- Visualiser et analyser dans Kibana
- D√©tecter proactivement les probl√®mes de performance

## Focus du projet : PARTIE CLIENTE

‚ö†Ô∏è **Note importante** : Ce projet se concentre **principalement sur la partie cliente (collecteur PowerShell)** car la partie serveur (stack ELK) est relativement standard et bien document√©e.

## Principes d'architecture

### Architecture de configuration INI ‚úÖ
Le syst√®me utilise un fichier `.ini` pour configurer les m√©triques :
- Liste des m√©triques √† collecter
- Fr√©quence de collecte par m√©trique (optimisation performance)
- Activation/d√©sactivation via commentaire de ligne
- Recharge √† chaud de la configuration (hot reload)
- Profils diff√©rents selon types de machines

**Avantages :**
- ‚úÖ D√©ploiement simplifi√© (GPO pour pousser config)
- ‚úÖ Maintenance facile (pas de recompilation)
- ‚úÖ Performance optimis√©e (fr√©quences diff√©renci√©es)
- ‚úÖ Debug facilit√© (activer/d√©sactiver rapidement)

## Architecture

### Composants principaux

#### 1. üéØ Agent Client (PowerShell) - FOCUS PRINCIPAL
- Script PowerShell s'ex√©cutant sur chaque endpoint
- Configuration via fichiers INI
- Collecte de m√©triques syst√®me et applicatives √† fr√©quences variables
- S√©rialisation en JSON
- Buffer local en cas d'indisponibilit√© serveur
- Envoi vers Logstash (HTTP/HTTPS)
- Service Windows ou T√¢che planifi√©e

#### 2. Serveur de collecte (Logstash) - Standard
- Reception des donn√©es JSON via HTTP input
- Parsing et enrichissement
- Indexation dans Elasticsearch

#### 3. Stockage et analyse (Elasticsearch) - Standard
- Stockage des m√©triques temporelles
- Indexation pour recherche rapide
- Agr√©gations pour analytics

#### 4. Visualisation (Kibana) - Standard
- Dashboards temps r√©el
- Alertes et notifications
- Rapports d'analyse

## M√©triques √† collecter

### ‚úÖ Validation de faisabilit√© PowerShell

**R√©sultat de l'analyse : 85-90% des m√©triques Nexthink sont reproductibles en PowerShell**

#### Cat√©gories parfaitement reproductibles (90-100%)
- ‚úÖ M√©triques syst√®me (CPU, RAM, Disk, I/O)
- ‚úÖ M√©triques hardware (Model, Serial, BIOS, Battery)
- ‚úÖ Inventaire software (apps install√©es, versions)
- ‚úÖ M√©triques r√©seau de base (connexions, latence, throughput)
- ‚úÖ M√©triques s√©curit√© (AV, Firewall, BitLocker, Updates)
- ‚úÖ √âv√©nements syst√®me (Event Logs)

#### Cat√©gories partiellement reproductibles (50-80%)
- ‚ö†Ô∏è M√©triques exp√©rience utilisateur (boot time, login time via Event Logs)
- ‚ö†Ô∏è D√©tection hangs/freeze (heuristiques via Event Logs)
- ‚ö†Ô∏è M√©triques r√©seau avanc√©es (RTT d√©taill√© n√©cessite monitoring continu)

#### Limitations (non reproductibles nativement)
- ‚ùå Page load time web (n√©cessite extension navigateur)
- ‚ùå Monitoring kernel-level continu (PowerShell = user-mode)
- ‚ùå Threat intelligence binaries (n√©cessite API externe type VirusTotal)
- ‚ùå Real-time monitoring < 1 minute (fr√©quence recommand√©e : 5 min)

**Conclusion : PowerShell est largement suffisant pour 85-90% des cas d'usage Nexthink**

### M√©triques Syst√®me
- [ ] CPU (utilisation moyenne, pics)
- [ ] M√©moire (RAM utilis√©e, disponible, paging)
- [ ] Disque (espace, I/O, fragmentation)
- [ ] R√©seau (latence, bande passante, connectivit√©)
- [ ] Uptime syst√®me
- [ ] √âv√©nements Windows critiques

### M√©triques Applications
- [ ] Applications install√©es et versions
- [ ] Temps de d√©marrage des applications
- [ ] Crashes et erreurs applicatives
- [ ] Utilisation ressources par application
- [ ] Applications non-r√©pondantes

### M√©triques Exp√©rience Utilisateur
- [ ] Temps de boot
- [ ] Temps de login
- [ ] Lenteurs per√ßues
- [ ] Freeze/hang detection
- [ ] Session crashes

### M√©triques S√©curit√©
- [ ] Status antivirus
- [ ] Mises √† jour Windows (derni√®re installation, patches manquants)
- [ ] Firewall status
- [ ] BitLocker status
- [ ] Ports ouverts suspects

### M√©triques Business
- [ ] Utilisateur et machine info (nom, domaine, site)
- [ ] Configuration mat√©rielle
- [ ] Mod√®le et constructeur
- [ ] Version OS et build

## Structure du projet

```
dex-monitoring/
‚îú‚îÄ‚îÄ client/                              # üéØ FOCUS PRINCIPAL
‚îÇ   ‚îú‚îÄ‚îÄ DEXCollector.ps1                 # Script principal (orchestrateur)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ config/                          # ‚öôÔ∏è Configuration INI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metrics.ini                  # Configuration des m√©triques et fr√©quences
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ collector.ini                # Configuration g√©n√©rale du collecteur
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profiles/                    # Profils par type de machine
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metrics-server.ini       # Profil pour serveurs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metrics-desktop.ini      # Profil pour desktops
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ metrics-laptop.ini       # Profil pour laptops
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md                    # Documentation configuration
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ modules/                         # üì¶ Modules PowerShell
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConfigParser.psm1            # Parse et valide fichiers INI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MetricsScheduler.psm1        # Gestion des fr√©quences de collecte
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MetricsCollector.psm1        # Orchestration collecte m√©triques
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DataSender.psm1              # Envoi vers Logstash + buffer local
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Logger.psm1                  # Logging local
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ collectors/                      # üîç Collecteurs sp√©cialis√©s par cat√©gorie
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SystemMetrics.psm1           # CPU, RAM, Disk, I/O
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NetworkMetrics.psm1          # R√©seau, latence, connectivit√©
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ApplicationMetrics.psm1      # Apps, processus, crashes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SecurityMetrics.psm1         # AV, Firewall, Updates, BitLocker
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserExperienceMetrics.psm1   # Boot, login, session
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HardwareMetrics.psm1         # Hardware info, battery
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EventMetrics.psm1            # Event Logs Windows
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ installer/                       # üì¶ Installation et d√©ploiement
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Install-DEXAgent.ps1         # Script d'installation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Uninstall-DEXAgent.ps1       # Script de d√©sinstallation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Register-Service.ps1         # Cr√©ation service Windows
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Deploy-GPO.ps1               # Aide d√©ploiement GPO
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ tests/                           # üß™ Tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Test-Collectors.ps1          # Tests unitaires collecteurs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Test-ConfigParser.ps1        # Tests parsing INI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Test-EndToEnd.ps1            # Tests bout-en-bout
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ docs/                            # üìö Documentation
‚îÇ       ‚îú‚îÄ‚îÄ installation.md              # Guide installation
‚îÇ       ‚îú‚îÄ‚îÄ configuration.md             # Guide configuration INI
‚îÇ       ‚îú‚îÄ‚îÄ metrics-reference.md         # R√©f√©rence toutes les m√©triques
‚îÇ       ‚îî‚îÄ‚îÄ troubleshooting.md           # Guide d√©pannage
‚îÇ
‚îú‚îÄ‚îÄ server/                              # ‚öôÔ∏è Configuration ELK (standard)
‚îÇ   ‚îú‚îÄ‚îÄ logstash/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pipelines/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dex-pipeline.conf        # Pipeline Logstash
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ patterns/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ dex-patterns             # Grok patterns custom
‚îÇ   ‚îú‚îÄ‚îÄ elasticsearch/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mappings/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dex-index-template.json  # Template d'index
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ queries/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sample-queries.json      # Requ√™tes exemples
‚îÇ   ‚îî‚îÄ‚îÄ kibana/
‚îÇ       ‚îú‚îÄ‚îÄ dashboards/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ overview.ndjson          # Dashboard vue g√©n√©rale
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ performance.ndjson       # Dashboard performance
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ security.ndjson          # Dashboard s√©curit√©
‚îÇ       ‚îî‚îÄ‚îÄ visualizations/
‚îÇ           ‚îî‚îÄ‚îÄ *.ndjson                 # Visualisations
‚îÇ
‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml               # Stack ELK pour dev/test
‚îÇ   ‚îî‚îÄ‚îÄ .env.example                     # Variables d'environnement
‚îÇ
‚îî‚îÄ‚îÄ README.md
```

## Architecture de configuration INI

### Format du fichier metrics.ini

Le fichier `metrics.ini` contr√¥le quelles m√©triques sont collect√©es et √† quelle fr√©quence.

```ini
# Format : MetricName = Enabled, FrequencyMinutes, Priority

[System]
CPUUsage = true, 5, high              # Collect√© toutes les 5 minutes
MemoryUsage = true, 5, high
DiskSpace = true, 15, medium          # Collect√© toutes les 15 minutes
DiskIO = false, 10, low               # D√©sactiv√© (via false)
# SystemUptime = true, 60, low        # D√©sactiv√© (via commentaire)

[Network]
ActiveConnections = true, 5, high
GatewayLatency = true, 15, medium
WiFiSignalStrength = true, 10, medium

[Applications]
RunningProcesses = true, 10, medium
TopCPUConsumers = true, 5, high
ApplicationCrashes = true, 5, high
InstalledApplications = true, 1440, low  # Une fois par jour

[Security]
AntivirusStatus = true, 30, high
FirewallStatus = true, 30, high
WindowsUpdateStatus = true, 60, high
PendingUpdates = true, 120, medium

[UserExperience]
BootTime = true, 0, high              # 0 = event-driven (√† chaque boot)
LoginTime = true, 0, high             # 0 = event-driven (√† chaque login)
SessionUptime = true, 30, medium

[Hardware]
ComputerModel = true, 1440, low       # Une fois par jour (donn√©es statiques)
BatteryHealth = true, 60, medium
BatteryStatus = true, 15, medium

[Events]
SystemErrors = true, 15, high
CriticalEvents = true, 5, high
```

### Format du fichier collector.ini

Configuration g√©n√©rale du collecteur :

```ini
[General]
CollectorVersion = 1.0.0
LogLevel = INFO                       # DEBUG, INFO, WARNING, ERROR

[Collection]
BaseFrequency = 5                     # Fr√©quence de base en minutes
BufferSize = 60                       # Taille buffer local en minutes
MaxRetries = 3                        # Tentatives d'envoi

[Logstash]
Endpoint = https://logstash.example.com:5044
UseAuthentication = false
Timeout = 30

[Local]
LogPath = C:\ProgramData\DEXCollector\logs
LogRetentionDays = 7
BufferPath = C:\ProgramData\DEXCollector\buffer
MaxBufferSizeMB = 100

[Performance]
MaxCPUUsage = 5                       # Impact CPU max autoris√© (%)
CollectionDelay = 100                 # D√©lai entre collectes (ms)
MetricTimeout = 30                    # Timeout par m√©trique (secondes)

[Advanced]
AutoReloadConfig = true               # Recharge auto de la config
ConfigReloadInterval = 15             # Fr√©quence reload (minutes)
```

### Profils par type de machine

**metrics-server.ini** : Serveurs (fr√©quence √©lev√©e, toutes m√©triques)
```ini
[System]
CPUUsage = true, 2, high              # Toutes les 2 minutes
MemoryUsage = true, 2, high
DiskIO = true, 5, high                # Plus fr√©quent sur serveurs
```

**metrics-desktop.ini** : Postes de travail (fr√©quence standard)
```ini
[System]
CPUUsage = true, 5, high
MemoryUsage = true, 5, high
```

**metrics-laptop.ini** : Laptops (fr√©quence r√©duite, √©conomie batterie)
```ini
[System]
CPUUsage = true, 10, medium           # Moins fr√©quent
MemoryUsage = true, 10, medium
[Hardware]
BatteryHealth = true, 30, high        # Plus important sur laptop
BatteryStatus = true, 5, high
```

### Avantages de l'approche INI

1. **D√©ploiement simplifi√©**
   - Pousser nouvelle config via GPO
   - Pas de recompilation du code
   - Hot reload automatique

2. **Flexibilit√©**
   - Activer/d√©sactiver m√©triques rapidement
   - Ajuster fr√©quences selon charge
   - Profils diff√©rents par type de machine

3. **Performance optimis√©e**
   - M√©triques group√©es par fr√©quence
   - √âvite collectes inutiles
   - Cache des donn√©es statiques

4. **Maintenance simplifi√©e**
   - Commentaire = d√©sactivation
   - Lisible par humains
   - Versionnable (Git)

5. **Debug facilit√©**
   - Activer temporairement verbose logging
   - Forcer collecte de m√©triques sp√©cifiques
   - Ajuster timeouts sans red√©ployer

### Syst√®me de scheduling

Le collecteur utilise un syst√®me de scheduling intelligent :

1. **Groupement par fr√©quence**
   - M√©triques √† 5 min ‚Üí Timer 1
   - M√©triques √† 15 min ‚Üí Timer 2
   - M√©triques √† 60 min ‚Üí Timer 3
   - Optimise le nombre de threads

2. **Event-driven pour m√©triques sp√©ciales**
   - BootTime : d√©clench√© au boot (Event Log)
   - LoginTime : d√©clench√© au login (Event Log)
   - Fr√©quence = 0 dans le INI

3. **Cache pour donn√©es statiques**
   - ComputerModel, SerialNumber : collect√©s 1x/jour
   - Stock√©s en cache local
   - R√©duit overhead

4. **Hot reload de configuration**
   - FileSystemWatcher sur metrics.ini
   - Recharge automatique des timers
   - Pas de red√©marrage n√©cessaire

## Phases de d√©veloppement

### Phase 1 : POC Collecteur (Focus Client) ‚≠ê
**Objectif : Valider le concept de base avec fichier INI**

- [ ] Cr√©er structure de base du projet client
- [ ] Impl√©menter ConfigParser.psm1 (lecture fichier INI)
- [ ] Cr√©er metrics.ini avec 5 m√©triques basiques
  - CPUUsage (5 min)
  - MemoryUsage (5 min)
  - DiskSpace (15 min)
  - InternetConnectivity (10 min)
  - AntivirusStatus (30 min)
- [ ] Cr√©er collecteurs basiques pour ces 5 m√©triques
- [ ] Impl√©menter syst√®me de scheduling simple
- [ ] G√©n√©rer JSON valide avec timestamp
- [ ] Logger les collectes localement
- [ ] Test manuel complet

**Livrables :**
- Script PowerShell fonctionnel
- Fichier metrics.ini basique
- Logs de collecte
- JSON g√©n√©r√©

### Phase 2 : Configuration serveur ELK (Standard)
- [ ] Setup Docker Compose pour stack ELK
- [ ] Configurer Logstash HTTP input
- [ ] Cr√©er pipeline basique (parse JSON)
- [ ] Configurer index template Elasticsearch
- [ ] Cr√©er dashboard Kibana simple
- [ ] Tester envoi de donn√©es du collecteur ‚Üí ELK
- [ ] Valider bout-en-bout

### Phase 3 : Enrichissement collecteur
**Objectif : Ajouter toutes les m√©triques et fonctionnalit√©s avanc√©es**

#### 3.1 M√©triques compl√®tes
- [ ] Impl√©menter tous les collecteurs
  - SystemMetrics.psm1 complet
  - NetworkMetrics.psm1 complet
  - ApplicationMetrics.psm1 complet
  - SecurityMetrics.psm1 complet
  - UserExperienceMetrics.psm1
  - HardwareMetrics.psm1
  - EventMetrics.psm1
- [ ] Enrichir metrics.ini avec toutes les m√©triques
- [ ] Cr√©er profils (server, desktop, laptop)

#### 3.2 Fonctionnalit√©s avanc√©es
- [ ] Impl√©menter DataSender.psm1 (envoi HTTP vers Logstash)
- [ ] Buffer local si Logstash indisponible
- [ ] Retry logic avec backoff exponentiel
- [ ] Hot reload de configuration (FileSystemWatcher)
- [ ] Event-driven metrics (BootTime, LoginTime)
- [ ] Cache pour donn√©es statiques
- [ ] Gestion erreurs robuste
- [ ] Logging structur√©
- [ ] Performance monitoring (impact CPU/RAM)

#### 3.3 Tests
- [ ] Tests unitaires par collecteur
- [ ] Tests de performance (overhead)
- [ ] Tests de r√©silience (Logstash down)
- [ ] Tests de charge (1000+ endpoints simul√©s)

### Phase 4 : D√©ploiement et automation
**Objectif : Industrialiser le d√©ploiement**

- [ ] Script d'installation automatique (Install-DEXAgent.ps1)
- [ ] Cr√©ation service Windows / T√¢che planifi√©e
- [ ] Script de d√©sinstallation propre
- [ ] Packaging (optionnel : MSI/MSIX)
- [ ] Documentation d√©ploiement GPO
- [ ] Script de mise √† jour automatique
- [ ] Gestion des versions (versionning collecteur)
- [ ] Rollback automatique si erreur
- [ ] Tests d√©ploiement multi-machines

### Phase 5 : Analytics et dashboards
**Objectif : Exploiter les donn√©es collect√©es**

- [ ] Optimiser pipeline Logstash (filtres, enrichissement)
- [ ] Index templates Elasticsearch optimis√©s
- [ ] Index Lifecycle Management (ILM)
- [ ] Retention policies configurables
- [ ] Dashboards Kibana avanc√©s
  - Overview g√©n√©ral
  - Performance syst√®me
  - Applications
  - S√©curit√©
  - R√©seau
  - Exp√©rience utilisateur
- [ ] Alertes Elasticsearch (Watcher ou Kibana Alerts)
- [ ] Rapports automatiques (PDF)
- [ ] Int√©grations (Teams, Slack, email)

### Phase 6 : Fonctionnalit√©s avanc√©es (Optionnel)
**Objectif : Fonctionnalit√©s type Nexthink avanc√©**

- [ ] D√©tection d'anomalies (Elasticsearch ML)
- [ ] Corr√©lation d'√©v√©nements
- [ ] Rem√©diation automatique (scripts PowerShell d√©clench√©s)
- [ ] API REST pour requ√™tes custom
- [ ] Interface web custom (React/Vue)
- [ ] Int√©grations ITSM (ServiceNow, Jira)
- [ ] Threat intelligence (int√©gration VirusTotal API)
- [ ] Network flow analysis avanc√©
- [ ] User behavior analytics

### Phase 7 : Production et monitoring
**Objectif : Op√©rations en production**

- [ ] Monitoring de la stack ELK elle-m√™me
- [ ] Alertes sur agents silencieux
- [ ] Dashboard sant√© du syst√®me de monitoring
- [ ] Documentation op√©rationnelle compl√®te
- [ ] Runbooks incidents
- [ ] Plan de capacity planning
- [ ] Backup/restore Elasticsearch
- [ ] DR (Disaster Recovery) plan

## Exemple de structure JSON

```json
{
  "timestamp": "2026-01-15T10:30:00Z",
  "agent_version": "1.0.0",
  "computer": {
    "hostname": "LAPTOP-USER01",
    "domain": "CORP",
    "os": "Windows 11 Pro",
    "os_build": "22621.1234",
    "manufacturer": "Dell Inc.",
    "model": "Latitude 7420",
    "serial": "ABC123XYZ"
  },
  "user": {
    "username": "jdoe",
    "domain": "CORP",
    "sid": "S-1-5-21-..."
  },
  "metrics": {
    "system": {
      "cpu_percent": 45.2,
      "memory_percent": 62.8,
      "memory_available_mb": 6144,
      "disk_c_free_gb": 125.4,
      "uptime_hours": 72
    },
    "network": {
      "primary_adapter": "Ethernet",
      "ip_address": "192.168.1.100",
      "gateway_latency_ms": 2,
      "dns_resolution_ms": 15,
      "internet_connected": true
    },
    "applications": {
      "running_count": 24,
      "top_cpu": [
        {"name": "chrome.exe", "cpu": 12.5},
        {"name": "outlook.exe", "cpu": 8.2}
      ],
      "top_memory": [
        {"name": "chrome.exe", "memory_mb": 1024},
        {"name": "teams.exe", "memory_mb": 512}
      ]
    },
    "security": {
      "antivirus_enabled": true,
      "antivirus_updated": true,
      "firewall_enabled": true,
      "windows_updates_pending": 2,
      "last_update_date": "2026-01-10"
    },
    "experience": {
      "boot_time_seconds": 45,
      "login_time_seconds": 12,
      "app_crashes_24h": 0,
      "system_freezes_24h": 1
    }
  },
  "events": [
    {
      "type": "error",
      "source": "Application",
      "event_id": 1000,
      "message": "Application crash detected"
    }
  ]
}
```

## Consid√©rations techniques

### Architecture du collecteur client

#### Syst√®me de scheduling
```
Orchestrateur principal (DEXCollector.ps1)
    ‚Üì
ConfigParser ‚Üí Charge metrics.ini
    ‚Üì
MetricsScheduler ‚Üí Groupe par fr√©quence
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Timer 5 min    ‚îÇ  Timer 15 min    ‚îÇ  Timer 60 min    ‚îÇ
‚îÇ  (haute freq)   ‚îÇ  (moyenne freq)  ‚îÇ  (basse freq)    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ CPUUsage        ‚îÇ DiskSpace        ‚îÇ WinUpdates       ‚îÇ
‚îÇ MemoryUsage     ‚îÇ GatewayLatency   ‚îÇ BatteryHealth    ‚îÇ
‚îÇ ActiveConn      ‚îÇ WiFiSignal       ‚îÇ HW Inventory     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì                   ‚Üì                    ‚Üì
MetricsCollector ‚Üí Invoque collecteurs sp√©cialis√©s
    ‚Üì
G√©n√©ration JSON ‚Üí Format standardis√©
    ‚Üì
DataSender ‚Üí Envoi vers Logstash (ou buffer local)
```

#### Gestion de la configuration

**Hot reload avec FileSystemWatcher :**
```
metrics.ini modifi√©
    ‚Üì
FileSystemWatcher d√©tecte changement
    ‚Üì
Recharge configuration
    ‚Üì
Reconfigure timers √† chaud
    ‚Üì
Pas de red√©marrage n√©cessaire
```

**Profils selon environnement :**
- Detection automatique du type de machine
- Chargement du profil appropri√©
- Fallback sur profil par d√©faut

#### Performance et optimisation

**Groupement intelligent :**
- M√©triques collect√©es ensemble si m√™me source (ex: WMI)
- R√©duction du nombre d'appels syst√®me
- Cache des donn√©es statiques

**Impact ressources :**
- Target < 5% CPU pendant collecte
- Pic < 10 secondes toutes les 5 minutes
- M√©moire < 50 MB
- R√©seau < 10 KB par collecte

**Parall√©lisation :**
```powershell
# Collecte en parall√®le pour m√©triques ind√©pendantes
$jobs = @()
$jobs += Start-Job { Get-SystemMetrics }
$jobs += Start-Job { Get-NetworkMetrics }
$jobs | Wait-Job | Receive-Job
```

### S√©curit√©
- Chiffrement HTTPS pour transport des donn√©es
- Authentification API Logstash
- Pas de donn√©es sensibles dans les m√©triques
- Permissions minimales pour l'agent PowerShell

### Performance
- Collecte l√©g√®re (< 5% CPU)
- Fr√©quence configurable (ex: toutes les 5 min)
- Buffer local en cas d'indisponibilit√© serveur
- Compression des donn√©es JSON

### Scalabilit√©
- Support de milliers d'endpoints
- Sharding Elasticsearch
- Load balancing Logstash
- Archivage des donn√©es anciennes

### Monitoring
- Healthcheck de l'agent
- Monitoring de la stack ELK
- Alertes si agents silencieux

## D√©ploiement et gestion des configurations

### Strat√©gie de d√©ploiement par GPO

**√âtape 1 : D√©ploiement initial**
```powershell
# Via GPO - Computer Configuration - Scripts - Startup
\\domain\SYSVOL\scripts\Install-DEXAgent.ps1

# Installation sur C:\ProgramData\DEXCollector
# Cr√©ation service/t√¢che planifi√©e automatique
```

**√âtape 2 : Distribution configuration**
```powershell
# Via GPO - Computer Configuration - Preferences - Files
Source: \\domain\SYSVOL\DEXCollector\metrics-desktop.ini
Destination: C:\ProgramData\DEXCollector\config\metrics.ini

# Mise √† jour automatique √† chaque refresh GPO
```

**√âtape 3 : Profils par OU**
```
Domain
‚îú‚îÄ‚îÄ Servers OU ‚Üí metrics-server.ini
‚îú‚îÄ‚îÄ Desktops OU ‚Üí metrics-desktop.ini
‚îú‚îÄ‚îÄ Laptops OU ‚Üí metrics-laptop.ini
‚îî‚îÄ‚îÄ VDI OU ‚Üí metrics-vdi.ini
```

### Gestion centralis√©e des configurations

**Repository central :**
```
\\domain\SYSVOL\DEXCollector\
‚îú‚îÄ‚îÄ collector.ini                 # Config g√©n√©rale
‚îú‚îÄ‚îÄ profiles/
‚îÇ   ‚îú‚îÄ‚îÄ metrics-server.ini
‚îÇ   ‚îú‚îÄ‚îÄ metrics-desktop.ini
‚îÇ   ‚îú‚îÄ‚îÄ metrics-laptop.ini
‚îÇ   ‚îî‚îÄ‚îÄ metrics-vdi.ini
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ Update-ConfigVersion.ps1  # Script de rollout
‚îî‚îÄ‚îÄ versions/
    ‚îú‚îÄ‚îÄ v1.0.0/
    ‚îú‚îÄ‚îÄ v1.1.0/
    ‚îî‚îÄ‚îÄ current ‚Üí v1.1.0 (symlink)
```

**Mise √† jour configuration :**
```powershell
# Modifier metrics.ini sur le share
# Les agents rechargent automatiquement (hot reload)
# Ou forcer refresh :
Invoke-GPUpdate -Computer "DESKTOP-001" -Force
```

### Versions et rollback

**Versionning automatique :**
```ini
# metrics.ini
[Metadata]
ConfigVersion = 1.2.0
LastModified = 2026-01-15T10:30:00Z
MinCollectorVersion = 1.0.0

# Le collecteur v√©rifie compatibilit√©
```

**Rollback en cas de probl√®me :**
```powershell
# Via script ou manuel
Copy-Item "versions\v1.0.0\metrics.ini" -Destination "current\"
# Les agents rechargent automatiquement
```

### Monitoring du d√©ploiement

**Validation d√©ploiement :**
- Dashboards Kibana montrent version config par machine
- Alertes si version obsol√®te d√©tect√©e
- Rapport de conformit√© automatique

## Monitoring

## Technologies et d√©pendances

### Client
- PowerShell 5.1+ (compatible Windows 10/11)
- Modules optionnels : PSWindowsUpdate, etc.

### Serveur
- Elasticsearch 8.x
- Logstash 8.x
- Kibana 8.x
- Docker & Docker Compose (pour d√©ploiement)

## Ressources et r√©f√©rences

### Documentation
- [PowerShell Documentation](https://docs.microsoft.com/powershell/)
- [Elasticsearch Guide](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)
- [Logstash Documentation](https://www.elastic.co/guide/en/logstash/current/index.html)
- [Kibana Guide](https://www.elastic.co/guide/en/kibana/current/index.html)

### Inspiration
- Nexthink architecture
- Windows Performance Counters
- SIEM best practices

## D√©cisions d'architecture importantes

### ‚úÖ Pourquoi fichiers INI plut√¥t que JSON/YAML ?

**Avantages INI :**
- ‚úÖ Format simple, lisible par tous
- ‚úÖ Commentaires natifs (#)
- ‚úÖ Facile √† √©diter manuellement
- ‚úÖ Pas de risque d'erreur de syntaxe complexe
- ‚úÖ PowerShell parse nativement (ou facilement)

**Comparaison :**
```ini
# INI - Simple et clair
[System]
CPUUsage = true, 5, high
# MemoryUsage = true, 5, high  ‚Üê D√©sactiv√© par commentaire
```

```json
// JSON - Plus verbeux, pas de commentaires standards
{
  "System": {
    "CPUUsage": {
      "enabled": true,
      "frequency": 5,
      "priority": "high"
    }
  }
}
```

### ‚úÖ Pourquoi fr√©quences diff√©renci√©es par m√©trique ?

**Raisons :**
1. **Performance** : √âviter overhead inutile
   - CPU/RAM : changent rapidement ‚Üí 5 min
   - Model/Serial : statiques ‚Üí 1x/jour
   
2. **R√©seau** : R√©duire trafic
   - M√©triques critiques : haute fr√©quence
   - Inventaire : basse fr√©quence
   
3. **Flexibilit√©** : Adapter selon contexte
   - Serveurs critiques : fr√©quence √©lev√©e
   - Laptops : fr√©quence r√©duite (batterie)

### ‚úÖ Pourquoi PowerShell plut√¥t que Python/C# ?

**Avantages PowerShell :**
- ‚úÖ Natif Windows (pr√©-install√©)
- ‚úÖ Acc√®s direct WMI/CIM
- ‚úÖ Acc√®s direct Event Logs
- ‚úÖ Pas de d√©pendances externes
- ‚úÖ Int√©gration parfaite GPO
- ‚úÖ Signing de scripts natif
- ‚úÖ Expertise r√©pandue en entreprise

### ‚úÖ Service Windows vs T√¢che planifi√©e ?

**Recommandation : T√¢che planifi√©e**

**Avantages :**
- ‚úÖ Plus simple √† d√©ployer (GPO)
- ‚úÖ Pas besoin droits admin pour modifier
- ‚úÖ Logs int√©gr√©s Windows
- ‚úÖ Retry automatique si √©chec
- ‚úÖ Visible dans Task Scheduler

**Service Windows si :**
- Besoin de monitoring temps r√©el (< 1 min)
- Besoin de r√©activit√© imm√©diate
- Contexte serveur critique

### ‚úÖ Buffer local : Pourquoi et comment ?

**Pourquoi :**
- Logstash peut √™tre indisponible (r√©seau, maintenance)
- Pas de perte de donn√©es
- Garantie de livraison

**Comment :**
```
C:\ProgramData\DEXCollector\buffer\
‚îú‚îÄ‚îÄ 2026-01-15_10-00.json  ‚Üê En attente d'envoi
‚îú‚îÄ‚îÄ 2026-01-15_10-05.json
‚îî‚îÄ‚îÄ 2026-01-15_10-10.json
```

**M√©canisme :**
1. Collecte ‚Üí G√©n√®re JSON
2. Tentative envoi Logstash
3. Si √©chec ‚Üí Sauvegarde dans buffer
4. Retry p√©riodique (backoff exponentiel)
5. Nettoyage apr√®s envoi r√©ussi
6. Limite taille buffer (ex: 100 MB)

## Prochaines √©tapes pour d√©marrer

### üéØ Phase 1 : POC Collecteur client (2-3 jours)

**Jour 1 : Setup de base**
1. Cr√©er structure projet
   ```
   client/
   ‚îú‚îÄ‚îÄ DEXCollector.ps1
   ‚îú‚îÄ‚îÄ config/
   ‚îÇ   ‚îî‚îÄ‚îÄ metrics.ini
   ‚îî‚îÄ‚îÄ modules/
       ‚îî‚îÄ‚îÄ ConfigParser.psm1
   ```

2. Cr√©er metrics.ini minimal (5 m√©triques)
   ```ini
   [System]
   CPUUsage = true, 5, high
   MemoryUsage = true, 5, high
   DiskSpace = true, 15, medium
   
   [Network]
   InternetConnectivity = true, 10, high
   
   [Security]
   AntivirusStatus = true, 30, high
   ```

3. Impl√©menter ConfigParser.psm1
   - Lecture et parsing du INI
   - Validation des valeurs
   - Retour d'objets PowerShell

**Jour 2 : Collecteurs et scheduling**
4. Cr√©er collecteurs basiques
   - SystemMetrics.psm1 (CPU, RAM, Disk)
   - NetworkMetrics.psm1 (connectivit√©)
   - SecurityMetrics.psm1 (AV status)

5. Impl√©menter scheduling simple
   - Groupement par fr√©quence
   - Boucle principale avec tracking
   - G√©n√©ration JSON avec timestamp

**Jour 3 : Tests et logging**
6. Ajouter logging local
7. Tests manuels complets
8. Validation du JSON g√©n√©r√©
9. Documentation du POC

**Livrable Phase 1 :**
- Collecteur fonctionnel avec 5 m√©triques
- Configuration INI op√©rationnelle
- JSON valide g√©n√©r√©
- Logs de collecte

### Phase 2 : Stack ELK (1 jour)

**Objectif : Valider bout-en-bout**

1. **Setup de l'environnement de dev**
   - Docker Compose avec stack ELK
   - Configuration Logstash HTTP input
   - Index template Elasticsearch basique

2. **Configurer pipeline Logstash**
   ```conf
   input {
     http {
       port => 5044
       codec => json
     }
   }
   
   filter {
     # Enrichissement basique
   }
   
   output {
     elasticsearch {
       hosts => ["elasticsearch:9200"]
       index => "dex-metrics-%{+YYYY.MM.dd}"
     }
   }
   ```

3. **Int√©gration collecteur ‚Üí Logstash**
   - Ajouter DataSender.psm1
   - Envoi HTTP POST vers Logstash
   - Test bout-en-bout

4. **Cr√©er dashboard Kibana**
   - Visualisation temps r√©el
   - Graphiques basiques (CPU, RAM, Disk)

**Livrable Phase 2 :**
- Stack ELK fonctionnelle (Docker)
- Donn√©es visibles dans Kibana
- Pipeline valid√© bout-en-bout

### Phase 3 : Extension (1-2 semaines)

**√Ä partir du POC valid√© :**
- Ajouter toutes les m√©triques (30-40 m√©triques)
- Impl√©menter buffer local
- Hot reload de configuration
- Event-driven metrics (boot, login)
- Tests unitaires et performance
- Scripts d'installation

### Points d'attention pour d√©marrer

‚úÖ **Commencer simple**
- Ne pas essayer de tout faire d'un coup
- POC avec 5 m√©triques suffit pour validation
- Ajouter fonctionnalit√©s progressivement

‚úÖ **Tests fr√©quents**
- Tester chaque m√©trique individuellement
- Valider le JSON g√©n√©r√©
- V√©rifier l'impact performance (CPU/RAM)

‚úÖ **Documentation continue**
- Documenter les d√©cisions
- Commenter le code
- Cr√©er des exemples

‚úÖ **It√©ration rapide**
- POC en 2-3 jours max
- Feedback rapide
- Ajustements selon r√©sultats

## Notes
- Privil√©gier la simplicit√© au d√©but
- It√©rer rapidement sur le POC
- Documenter au fur et √† mesure
- Pr√©voir les cas d'erreur d√®s le d√©but
